DROP USER METUSER CASCADE;

DROP TABLE OAUTH_CLIENT_DETAILS;

CREATE USER METUSER IDENTIFIED BY METUSER;

GRANT CREATE SESSION, ALTER SESSION, CREATE DATABASE LINK, -
  CREATE MATERIALIZED VIEW, CREATE PROCEDURE, CREATE PUBLIC SYNONYM, -
  CREATE ROLE, CREATE SEQUENCE, CREATE SYNONYM, CREATE TABLE, - 
  CREATE TRIGGER, CREATE TYPE, CREATE VIEW, UNLIMITED TABLESPACE -
  TO METUSER;
  
GRANT EXECUTE ON SYS.DBMS_CRYPTO TO METUSER;

CREATE TABLE OAUTH_CLIENT_DETAILS (
CLIENT_ID VARCHAR2(255 CHAR) NOT NULL PRIMARY KEY,
CLIENT_SECRET VARCHAR2(255 CHAR) NOT NULL,
RESOURCE_IDS VARCHAR2(255 CHAR) DEFAULT NULL,
SCOPE VARCHAR2(255 CHAR) DEFAULT NULL,
AUTHORIZED_GRANT_TYPES VARCHAR2(255 CHAR) DEFAULT NULL,
WEB_SERVER_REDIRECT_URI VARCHAR2(255 CHAR) DEFAULT NULL,
AUTHORITIES VARCHAR2(255 CHAR) DEFAULT NULL,
ACCESS_TOKEN_VALIDITY NUMBER(11) DEFAULT NULL,
REFRESH_TOKEN_VALIDITY NUMBER(11) DEFAULT NULL,
ADDITIONAL_INFORMATION VARCHAR2(3000) DEFAULT NULL,
AUTOAPPROVE VARCHAR2(255 CHAR) DEFAULT NULL
);

GRANT SELECT ON OAUTH_CLIENT_DETAILS TO METUSER;

CREATE TABLE METUSER.PERMISSION (
PERMISSION_ID NUMBER NOT NULL PRIMARY KEY,
NAME VARCHAR(60) NOT NULL UNIQUE
);

CREATE SEQUENCE METUSER.PERM_SEQ  
START WITH 1000
INCREMENT BY 1 
NOCACHE  
NOORDER  
NOCYCLE ;

CREATE TABLE METUSER.ROLE_DET (
  ROLE_ID NUMBER NOT NULL PRIMARY KEY,
  ROLE VARCHAR2(255) DEFAULT NULL
);

CREATE SEQUENCE METUSER.ROLE_SEQ  
START WITH 1000
INCREMENT BY 1 
NOCACHE  
NOORDER  
NOCYCLE ;

CREATE TABLE METUSER.USER_DET (
  USER_ID NUMBER NOT NULL PRIMARY KEY,
  USERNAME VARCHAR2(255) NOT NULL,
  PASSWORD VARCHAR2(255) NOT NULL,
  FIRST_NAME VARCHAR2(255) NOT NULL,
  LAST_NAME VARCHAR2(255) NOT NULL,
  ENABLED NUMBER(1) NOT NULL,
  ACCOUNT_EXPIRED NUMBER(1) NOT NULL,
  CREDENTIALS_EXPIRED NUMBER(1) NOT NULL,
  ACCOUNT_LOCKED NUMBER(1) NOT NULL
);

CREATE SEQUENCE METUSER.USERDET_SEQ  
START WITH 1000
INCREMENT BY 1 
NOCACHE  
NOORDER  
NOCYCLE ;

CREATE TABLE METUSER.PERMISSION_ROLE(
  ROLE_ID NUMBER NOT NULL,
  PERMISSION_ID NUMBER NOT NULL,
  CONSTRAINT PERMISSION_ROLE_PK PRIMARY KEY (PERMISSION_ID,ROLE_ID)
);

ALTER TABLE METUSER.PERMISSION_ROLE ADD CONSTRAINT FK_PERMISSION_ROLE1 FOREIGN KEY(ROLE_ID) REFERENCES METUSER.ROLE_DET(ROLE_ID);

ALTER TABLE METUSER.PERMISSION_ROLE ADD CONSTRAINT FK_PERMISSION_ROLE2 FOREIGN KEY(PERMISSION_ID) REFERENCES METUSER.PERMISSION(PERMISSION_ID);

CREATE TABLE METUSER.USER_ROLE (
  USER_ID NUMBER NOT NULL,
  ROLE_ID NUMBER NOT NULL,
  CONSTRAINT USER_ROLE_PK PRIMARY KEY (USER_ID,ROLE_ID)
);

ALTER TABLE METUSER.USER_ROLE ADD CONSTRAINT FK_USER_ROLE1 FOREIGN KEY (USER_ID) REFERENCES METUSER.USER_DET(USER_ID);

ALTER TABLE METUSER.USER_ROLE ADD CONSTRAINT FK_USER_ROLE2 FOREIGN KEY (ROLE_ID) REFERENCES METUSER.ROLE_DET(ROLE_ID);

INSERT INTO OAUTH_CLIENT_DETAILS (CLIENT_ID,CLIENT_SECRET, RESOURCE_IDS, SCOPE, AUTHORIZED_GRANT_TYPES, WEB_SERVER_REDIRECT_URI,AUTHORITIES,
	ACCESS_TOKEN_VALIDITY,REFRESH_TOKEN_VALIDITY, ADDITIONAL_INFORMATION,AUTOAPPROVE)
VALUES('OAuth2Client','{bcrypt}$2a$10$EOs8VROb14e7ZnydvXECA.4LoIhPOoFHKvVF/iBZ/ker17Eocz4Vi', 'USER_CLIENT_RESOURCE,USER_ADMIN_RESOURCE',
	'role_admin,role_user', 'authorization_code,password,refresh_token,implicit', NULL,NULL, 10800, 2592000,'{}',NULL);
	
INSERT INTO METUSER.PERMISSION VALUES (1,'CREATE_USER');
INSERT INTO METUSER.PERMISSION VALUES (2,'UPDATE_USER');
INSERT INTO METUSER.PERMISSION VALUES (3,'READ_USER');
INSERT INTO METUSER.PERMISSION VALUES (4,'DELETE_USER');	

INSERT INTO METUSER.ROLE_DET VALUES (1,'role_admin');
INSERT INTO METUSER.ROLE_DET VALUES (2,'role_user');

INSERT INTO METUSER.PERMISSION_ROLE (ROLE_ID,PERMISSION_ID) VALUES(1,1);
INSERT INTO METUSER.PERMISSION_ROLE (ROLE_ID,PERMISSION_ID) VALUES(1,2);
INSERT INTO METUSER.PERMISSION_ROLE (ROLE_ID,PERMISSION_ID) VALUES(1,3);
INSERT INTO METUSER.PERMISSION_ROLE (ROLE_ID,PERMISSION_ID) VALUES(1,4);
   
INSERT INTO METUSER.PERMISSION_ROLE (ROLE_ID,PERMISSION_ID) VALUES(2,2);
INSERT INTO METUSER.PERMISSION_ROLE (ROLE_ID,PERMISSION_ID) VALUES(2,3);

INSERT INTO METUSER.USER_DET (USER_ID,USERNAME,FIRST_NAME,LAST_NAME,PASSWORD,ENABLED,ACCOUNT_EXPIRED,CREDENTIALS_EXPIRED,ACCOUNT_LOCKED) 
	VALUES (1,'admin','admin','admin','{bcrypt}$2a$10$EOs8VROb14e7ZnydvXECA.4LoIhPOoFHKvVF/iBZ/ker17Eocz4Vi',1,0,0,0);
INSERT INTO METUSER.USER_DET (USER_ID,USERNAME,FIRST_NAME,LAST_NAME,PASSWORD,ENABLED,ACCOUNT_EXPIRED,CREDENTIALS_EXPIRED,ACCOUNT_LOCKED) 
	VALUES (2,'user','user','ravi','{bcrypt}$2a$10$EOs8VROb14e7ZnydvXECA.4LoIhPOoFHKvVF/iBZ/ker17Eocz4Vi',1,0,0,0);

INSERT INTO METUSER.USER_ROLE (USER_ID, ROLE_ID) VALUES (1, 1);

INSERT INTO METUSER.USER_ROLE (USER_ID, ROLE_ID) VALUES (2, 2);

COMMIT;